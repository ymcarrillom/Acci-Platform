# =============================================================================
# Nginx — Configuracion de produccion para ACCI Platform
#
# Dominios (reemplazar con los reales):
#   acci.example.com        → Next.js  (puerto 3000)
#   api.acci.example.com    → Express  (puerto 4000)
#
# Pasos para activar en el servidor:
#   1. Instalar Nginx y Certbot:
#        apt install nginx certbot python3-certbot-nginx
#
#   2. Copiar este archivo:
#        cp nginx/acci.conf /etc/nginx/sites-available/acci
#        ln -s /etc/nginx/sites-available/acci /etc/nginx/sites-enabled/acci
#
#   3. Reemplazar acci.example.com y api.acci.example.com con tus dominios.
#
#   4. Obtener certificados SSL (Certbot creara los bloques ssl automaticamente):
#        certbot --nginx -d acci.example.com -d api.acci.example.com
#
#   5. Verificar y recargar:
#        nginx -t && systemctl reload nginx
#
#   6. Renovacion automatica (ya la instala Certbot, verificar):
#        systemctl list-timers | grep certbot
# =============================================================================

# ── Rate limiting zones (definidas en el contexto http) ──────────────────────
# Nota: Si tienes un nginx.conf principal, mueve estos "limit_req_zone" al
# bloque http{} de /etc/nginx/nginx.conf en lugar de aqui.

limit_req_zone $binary_remote_addr zone=login:10m rate=10r/m;
limit_req_zone $binary_remote_addr zone=api:10m    rate=100r/m;
limit_req_zone $binary_remote_addr zone=web:10m    rate=200r/m;
limit_req_zone $binary_remote_addr zone=uploads:10m rate=5r/m;

# ── Upstream definitions ──────────────────────────────────────────────────────
upstream acci_api {
    server 127.0.0.1:4000;
    keepalive 32;
}

upstream acci_web {
    server 127.0.0.1:3000;
    keepalive 32;
}

# =============================================================================
# HTTP → HTTPS redirect (todos los dominios)
# =============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name acci.example.com api.acci.example.com;

    # Permite que Certbot valide el dominio por HTTP
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# =============================================================================
# FRONTEND — acci.example.com (Next.js)
# =============================================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name acci.example.com;

    # ── SSL (Certbot los completara automaticamente) ──────────────────────────
    ssl_certificate     /etc/letsencrypt/live/acci.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/acci.example.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ── Security headers ──────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options           "DENY"                     always;
    add_header X-Content-Type-Options    "nosniff"                  always;
    add_header Referrer-Policy           "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy        "camera=(), microphone=(), geolocation=()" always;
    # CSP: ajustar segun las fuentes que usa Next.js
    add_header Content-Security-Policy
        "default-src 'self'; \
         script-src 'self' 'unsafe-inline' 'unsafe-eval'; \
         style-src 'self' 'unsafe-inline'; \
         img-src 'self' data: blob: https:; \
         font-src 'self' data:; \
         connect-src 'self' https://api.acci.example.com; \
         frame-ancestors 'none';" always;

    # ── Logs ──────────────────────────────────────────────────────────────────
    access_log /var/log/nginx/acci-web-access.log combined;
    error_log  /var/log/nginx/acci-web-error.log  warn;

    # ── Gzip ─────────────────────────────────────────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json
               application/javascript application/xml+rss
               application/atom+xml image/svg+xml;

    # ── Proxy a Next.js ───────────────────────────────────────────────────────
    location / {
        limit_req zone=web burst=50 nodelay;

        proxy_pass         http://acci_web;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade           $http_upgrade;
        proxy_set_header   Connection        "upgrade";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        proxy_read_timeout  60s;
        proxy_send_timeout  60s;
        proxy_connect_timeout 10s;
    }

    # Next.js static assets — cache agresivo
    location /_next/static/ {
        proxy_pass http://acci_web;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
}

# =============================================================================
# API — api.acci.example.com (Express)
# =============================================================================
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name api.acci.example.com;

    # ── SSL ───────────────────────────────────────────────────────────────────
    ssl_certificate     /etc/letsencrypt/live/acci.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/acci.example.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    # ── Security headers ──────────────────────────────────────────────────────
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options    "nosniff"                  always;
    add_header X-Frame-Options           "DENY"                     always;
    add_header Referrer-Policy           "no-referrer"              always;

    # ── Logs ──────────────────────────────────────────────────────────────────
    access_log /var/log/nginx/acci-api-access.log combined;
    error_log  /var/log/nginx/acci-api-error.log  warn;

    # ── Gzip (solo respuestas JSON, no uploads) ───────────────────────────────
    gzip on;
    gzip_vary on;
    gzip_types application/json;

    # ── Limite de body global (las rutas de upload lo sobreescriben) ──────────
    client_max_body_size 25M;

    # ── Rate limit agresivo en auth ───────────────────────────────────────────
    location ~ ^/auth/(login|refresh) {
        limit_req zone=login burst=5 nodelay;
        limit_req_status 429;

        proxy_pass         http://acci_api;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_read_timeout  15s;
        proxy_connect_timeout 10s;
    }

    # ── Uploads de video (hasta 2GB, timeout largo, rate limiting) ────────────
    location ~ ^/courses/[^/]+/recovery-videos {
        limit_req zone=uploads burst=2 nodelay;
        limit_req_status 429;

        client_max_body_size  2100M;
        proxy_request_buffering off;  # stream directo sin bufferizar en nginx

        proxy_pass         http://acci_api;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_read_timeout    3600s;  # 1h para uploads grandes
        proxy_send_timeout    3600s;
        proxy_connect_timeout 10s;
    }

    # ── Bloquear acceso directo a recovery-videos (debe pasar por /stream) ────
    location /uploads/recovery-videos {
        return 403 '{"message":"Use la API para acceder a los videos"}';
        add_header Content-Type application/json;
    }

    # ── Health check — sin log ni rate limit ─────────────────────────────────
    location = /health {
        proxy_pass         http://acci_api;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        access_log off;
    }

    # ── Resto de la API ───────────────────────────────────────────────────────
    location / {
        limit_req zone=api burst=30 nodelay;
        limit_req_status 429;

        proxy_pass         http://acci_api;
        proxy_http_version 1.1;
        proxy_set_header   Connection        "";
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_read_timeout  30s;
        proxy_send_timeout  30s;
        proxy_connect_timeout 10s;
    }
}
